#!/usr/bin/env bash

declare -g BASHCLI_CACHE_DIR=${BASHCLI_CACHE_DIR:-${XDG_CACHE_HOME:-${HOME}/.cache}/${BASHCLI_CLI_NAME}/cache}

bashcli-cache-put() {
  local namespace=$1
  local key=$2
  local value=$3
  local filename

  if [ $# -ne 3 ]; then
    bashcli-error "usage: ${FUNCNAME} NAMESPACE KEY VALUE"
    return 1
  fi

  bashcli-cache-file "${namespace}" "${key}"
  filename=${REPLY}

  if [ "${value}" == - ]; then
    cat > "${filename}"
  else
    printf "%s" "${value}" > "${filename}"
  fi

  bashcli-debug "wrote ${filename}"
}

bashcli-cache-get() {
  local namespace=$1
  local key=$2

  if [ $# -ne 2 ]; then
    bashcli-error "usage: ${FUNCNAME} NAMESPACE KEY"
    return 1
  fi

  bashcli-cache-file "${namespace}" "${key}"
  if [ -f "${REPLY}" ]; then
    bashcli-debug "found ${REPLY}"
    IFS= read -d '' -r < "${REPLY}" || true
  else
    bashcli-debug "not found"
    return 1
  fi
}

bashcli-cache-file() {
  local namespace=$1
  local key=$2
  local directory=${BASHCLI_CACHE_DIR}/${namespace}
  REPLY=

  bashcli-debug "ns=${namespace} key='${key}'"

  if [ $# -ne 2 ]; then
    bashcli-error "usage: ${FUNCNAME} NAMESPACE KEY"
    return 1
  fi

  if [ -z "${key}" ]; then
    bashcli-error "key must not be empty"
    return 1
  fi

  if ! [ -d "${directory}" ]; then
    mkdir --parents "${directory}"
  fi

  bashcli-cache-hash < <(printf "%s" "${key}")
  REPLY=${directory}/${REPLY}
}

bashcli-cache-hash() {
  REPLY=$(sha1sum -)
  REPLY=${REPLY%% *}
}
