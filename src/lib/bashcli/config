#!/usr/bin/env bash


declare -g BASHCLI_CONFIG_GLOBAL=${BASHCLI_CONFIG_GLOBAL:-${XDG_CONFIG_HOME:-$HOME/.config}/${BASHCLI_CLI_NAME}/${BASHCLI_CLI_NAME}.conf}
declare -g BASHCLI_CONFIG_LOCAL=${BASHCLI_CONFIG_LOCAL}
declare -g BASHCLI_CONFIG_DEFAULTS=${BASHCLI_CONFIG_DEFAULTS}

declare -g BASHCLI_CONFIG_VALID_PROPERTY_NAME='+([a-zA-Z0-9.-])'
declare -g BASHCLI_CONFIG_VALID_PROFILE_NAME='*([a-zA-Z0-9-])'
declare -g BASHCLI_CONFIG_INITIALIZED='false'

declare -g -A BASHCLI_CONFIG_PROPERTIES=()
declare -g -A BASHCLI_CONFIG_PROPERTY_PROFILE=()
declare -g -A BASHCLI_CONFIG_KNOWN_PROFILES=()
declare -g -A BASHCLI_CONFIG_ENV=()

declare -g BASHCLI_CONFIG_PROFILES=()
declare -g BASHCLI_CONFIG_SCOPE=

bashcli-config-get() {
  local property=$1

  case $# in
    0) bashcli-error "property-name parameter missing"
       return 1 ;;
    1) ;;
    *) bashcli-error "too many arguments: $*"
       return 1;;
  esac

  bashcli-config-initialize
  bashcli-config-check-property "${property}"

  printf "%s\n" "${BASHCLI_CONFIG_PROPERTIES[${property}]}"
}

bashcli-config-set() {
  case $# in
    0) bashcli-error "property-name parameter missing"
       return 1 ;;
    1) bashcli-error "property-value parameter missing"
       return 1 ;;
    2) ;;
    *) bashcli-error "too many arguments: $*"
       return 1 ;;
  esac

  -bashcli-config-set false "$@"
}

bashcli-config-unset() {
  case $# in
    0) bashcli-error "property-name parameter missing"
       return 1 ;;
    1) ;;
    *) bashcli-error "too many arguments: $*"
       return 1 ;;
  esac

  -bashcli-config-set true "$@"
}

bashcli-config-list() {
  if [ $# -gt 0 ]; then
    bashcli-error "too many arguments: $*"
    return 1
  fi

  bashcli-config-initialize
  local IFS=$'\n'
  local property
  local properties=($(LC_ALL=C sort <<<"${!BASHCLI_CONFIG_PROPERTIES[@]}"))

  for property in "${properties[@]}"; do
    printf "%s=%s\n" "${property}" "${BASHCLI_CONFIG_PROPERTIES[${property}]}"
  done
}

bashcli-config-initialize() {
  local IFS line variable

  if [ "${BASHCLI_CONFIG_INITIALIZED}" == true ]; then
    return
  fi

  BASHCLI_CONFIG_INITIALIZED=true

  if [ -f "${BASHCLI_CONFIG_DEFAULTS}" ] && [ ! -f "${BASHCLI_CONFIG_GLOBAL}" ]; then
    mkdir -p "$(dirname "${BASHCLI_CONFIG_GLOBAL}")" \
      && cp "${BASHCLI_CONFIG_DEFAULTS}" "${BASHCLI_CONFIG_GLOBAL}"
  fi

  while IFS= read -r line || [ -n "${line}" ]; do
    variable=${line%%=*}
    BASHCLI_CONFIG_ENV[${variable}]=1
  done < <(env)

  -bashcli-config-read
}

bashcli-config-file() {
  local propertyFile
  local scope=${BASHCLI_CONFIG_SCOPE}

  if [ -z "${scope}" ]; then
    if [ "${BASHCLI_CONFIG_LOCAL}" ]; then
      scope=local
    else
      scope=global
    fi
  fi

  case ${scope} in
    global) propertyFile=${BASHCLI_CONFIG_GLOBAL} ;;
    local) propertyFile=${BASHCLI_CONFIG_LOCAL} ;;
    *) bashcli-fatal "internal error: invalid scope: ${scope}" ;;
  esac
  if [ -z "${propertyFile}" ]; then
    bashcli-fatal "internal error: property file unset"
  fi
  printf "%s" "${propertyFile}"
}

-bashcli-config-set() {
  local unset=$1
  local property=$2
  local value=$3
  local profile=

  if [ ${#BASHCLI_CONFIG_PROFILES[@]} -gt 0 ]; then
    profile=${BASHCLI_CONFIG_PROFILES[-1]}
  fi

  bashcli-string-trim property
  bashcli-string-trim value

  bashcli-config-check-property "${property}"
  bashcli-debug "${profile:-"''"}" "${property}" "${value}"
  -bashcli-config-write-value "${unset}" "${profile}" "${property}" "${value}"
}

-bashcli-config-read() {
  local IFS=,
  local propertyFiles=()
  local propertyFile

  if [ -z "${BASHCLI_CONFIG_SCOPE}" ] || [ "${BASHCLI_CONFIG_SCOPE}" == global ]; then
    propertyFiles+=("${BASHCLI_CONFIG_GLOBAL}")
  fi

  if [ -z "${BASHCLI_CONFIG_SCOPE}" ] || [ "${BASHCLI_CONFIG_SCOPE}" == local ]; then
    propertyFiles+=("${BASHCLI_CONFIG_LOCAL}")
  fi

  bashcli-debug "reading in scope ${BASHCLI_CONFIG_SCOPE:-"''"} with profiles [${BASHCLI_CONFIG_PROFILES[*]}]"

  for propertyFile in "${propertyFiles[@]}"; do
    if [ -f "${propertyFile}" ]; then
      -bashcli-config-read-file "${propertyFile}"
    fi
  done
}

-bashcli-config-read-file() {
  local propertyFile=$1
  local -A profileOrder=()
  local lineNumber=0
  local index line profile property value propertyProfile

  for ((index = 0; index < ${#BASHCLI_CONFIG_PROFILES[@]}; ++index)); do
    profileOrder[${BASHCLI_CONFIG_PROFILES[${index}]}]=${index}
  done

  bashcli-debug "reading ${propertyFile}"

  while IFS= read -r line || [ -n "${line}" ]; do
    if -bashcli-config-read-line "${line}" "${propertyFile}" "${lineNumber}"; then
      profile=${REPLY[0]}
      property=${REPLY[1]}
      value=${REPLY[2]}
      propertyProfile=${BASHCLI_CONFIG_PROPERTY_PROFILE[${property}]}

      if [ "${profile}" ]; then
        # shellcheck disable=SC2034
        BASHCLI_CONFIG_KNOWN_PROFILES[${profile}]=1
        if [ -z "${profileOrder[${profile}]}" ]; then
          continue
        fi
      fi

      if [ -z "${propertyProfile}" ] \
           || [ "${profileOrder[${profile}]}" -ge "${profileOrder[${propertyProfile}]}" ]; then
        BASHCLI_CONFIG_PROPERTIES[${property}]=${value}
        BASHCLI_CONFIG_PROPERTY_PROFILE[${property}]=${profile}
      fi
    fi
    ((++lineNumber))
  done < "${propertyFile}"
}

-bashcli-config-read-line() {
  local line=$1
  local propertyFile=$2
  local lineNumber=$3
  local profile property value

  if [[ ${line} == *( )\#* ]]; then
    return 1
  fi

  property=${line%%=*}
  value=${line#*=}
  bashcli-string-trim property
  bashcli-string-trim value

  -bashcli-config-split-profile "${property}"
  profile=${REPLY[0]}
  property=${REPLY[1]}

  if [ -z "${property}" ]; then
    bashcli-warn "failed to read line ${lineNumber} of file ${propertyFile}"
    return 1
  fi

  bashcli-config-check-property "${property}"

  bashcli-debug "${profile:-"''"} ${property} ${value}"
  REPLY=("${profile}" "${property}" "${value}")
}

-bashcli-config-split-profile() {
  local property=$1
  local profile=
  if [[ ${property} == %* ]]; then
    profile=${property%%.*}
    property=${property:${#profile}}
    property=${property:1}
    profile=${profile#\%}
  fi
  REPLY=("${profile}" "${property}")
}

-bashcli-config-write-value() {
  local unset=$1
  local profile=$2
  local property=$3
  local value=$4
  local profilePrefix
  local propertyFile
  local tempFile=$(mktemp)

  trap 'rm -f -- "${tempFile}"' RETURN

  bashcli-config-file
  propertyFile=${REPLY}

  if [ "${profile}" ]; then
    profilePrefix="%${profile}."
  fi

  if [ -f "${propertyFile}" ]; then
    while IFS= read -r line || [ -n "${line}" ]; do
      if -bashcli-config-read-line "${line}" "${propertyFile}" "${lineNumber}"; then
        if [ "${profile}" == "${REPLY[0]}" ] && [ "${property}" == "${REPLY[1]}" ]; then
          if [ "${unset}" != true ]; then
            unset=true
            printf "%s%s=%s\n" "${profilePrefix}" "${property}" "${value}"
          fi
        else
          printf "%s\n" "${line}"
        fi
      fi
      ((++lineNumber))
    done < "${propertyFile}" > "${tempFile}"
    if [ "${unset}" != true ]; then
      printf "%s%s=%s\n" "${profilePrefix}" "${property}" "${value}" >> "${tempFile}"
    fi
    mv "${tempFile}" "${propertyFile}"
  else
    printf "%s%s=%s\n" "${profilePrefix}" "${property}" "${value}" > "${propertyFile}"
  fi
}

-bashcli-config-env-get() {
  local variable=$1
  local variant

  -bashcli-config-env-init

  for ((variant = 0; variant < 3; ++variant)); do
    case ${variant} in
      0) ;;
      1) variable=${variable//./_} ;;
      2) variable=${variable^^} ;;
    esac

    if [ "${BASHCLI_CONFIG_ENV[${variable}]}" ]; then
      # shellcheck disable=SC2178
      REPLY=${!variable}
      return 0
    fi
  done

  return 1
}

bashcli-config-check-property() {
  local property=$1
  if [[ ${property} != ${BASHCLI_CONFIG_VALID_PROPERTY_NAME} ]]; then
    bashcli-error "invalid property name: ${property} (should match '${BASHCLI_CONFIG_VALID_PROPERTY_NAME}')"
    return 1
  fi
}

bashcli-config-check-profiles() {
  local profile
  for profile in "${BASHCLI_CONFIG_PROFILES[@]}"; do
    if [[ ${profile} != ${BASHCLI_CONFIG_VALID_PROFILE_NAME} ]]; then
      bashcli-error "invalid profile name: ${profile} (should match '${BASHCLI_CONFIG_VALID_PROFILE_NAME}')"
      return 1
    fi
  done
}

bashcli-config-check-scope() {
  case ${BASHCLI_CONFIG_SCOPE} in
    global|local|'') ;;
    *) bashcli-error "invalid scope: ${scope} (should be 'global', 'local' or empty)"
       return 1;;
  esac
}
