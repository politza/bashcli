#!/usr/bin/env bash

PATH=${PWD}/fixtures/options:${PATH}
output=$(mktemp)
trap "rm -r -- '${output}'" EXIT

test-no-options() {
  cli &> "${output}"
  diff "${output}" - <<EOF
EOF
}

test-boolean-option() {
  cli --boolean &> "${output}"
  diff "${output}" - <<EOF
boolean=true
EOF
}

test-single-option() {
  cli --single 0 &> "${output}"
  diff "${output}" - <<EOF
single=0
EOF
}

test-multi-list-option() {
  cli --multi-list a --multi-list b &> "${output}"
  diff "${output}" - <<EOF
multi-list=a
b
multi-list[0]=a
multi-list[1]=b
EOF
}

test-multi-list-split-options() {
  cli --multi-list=a,b,c &> "${output}"
  diff "${output}" - <<EOF
multi-list=a
b
c
multi-list[0]=a
multi-list[1]=b
multi-list[2]=c
EOF
}

test-multi-list-split-options-multiple-times() {
  cli --multi-list a,b,c --multi-list=d,e,f &> "${output}"
  diff "${output}" - <<EOF
multi-list=a
b
c
d
e
f
multi-list[0]=a
multi-list[1]=b
multi-list[2]=c
multi-list[3]=d
multi-list[4]=e
multi-list[5]=f
EOF
}

test-multi-list-split-options-aliased() {
  cli -ma,b,c &> "${output}"
  diff "${output}" - <<EOF
multi-list=a
b
c
multi-list[0]=a
multi-list[1]=b
multi-list[2]=c
EOF
}

test-multi-list-split-options-whitespace() {
  cli --multi-list=' a,  b,   c' &> "${output}"
  diff "${output}" - <<EOF
multi-list= a
  b
   c
multi-list[0]= a
multi-list[1]=  b
multi-list[2]=   c
EOF
}

test-multi-option() {
  cli --multi a,b,c --multi d,e,f &> "${output}"
  diff "${output}" - <<EOF
multi=a,b,c
d,e,f
multi[0]=a,b,c
multi[1]=d,e,f
EOF
}

test-enum-option() {
  cli --primary &> "${output}"
  diff "${output}" - <<EOF
enum=primary
EOF
}

test-alias-options() {
  cli -b -s a -m a,b -M c -e primary &> "${output}"
  diff -u "${output}" - <<EOF
boolean=true
single=a
multi=c
multi-list=a
b
multi-list[0]=a
multi-list[1]=b
multi[0]=c
enum=primary
EOF
}

test-concatenated-options() {
  cli -bs a -bbm a &> "${output}"
  diff -u "${output}" - <<EOF
boolean=true
single=a
multi-list=a
multi-list[0]=a
EOF
}

test-parameter-option() {
  cli a b &> "${output}"
  diff "${output}" - <<EOF
parameter[0]=a
parameter[1]=b
EOF
}

test-unknown-option() {
  cli --no-such-option &> "${output}" && return 1
  diff "${output}" - <<EOF
[error] unrecognized option: --no-such-option
EOF
}

test-single-requires-argument() {
  cli --single &> "${output}" && return 1
  diff "${output}" - <<EOF
[error] option requires an argument: --single
EOF
}

test-multi-list-requires-argument() {
  cli --multi-list &> "${output}" && return 1
  diff "${output}" - <<EOF
[error] option requires an argument: --multi-list
EOF
}

test-multi-requires-argument() {
  cli --multi &> "${output}" && return 1
  diff "${output}" - <<EOF
[error] option requires an argument: --multi
EOF
}

. ./lib/run-tests
