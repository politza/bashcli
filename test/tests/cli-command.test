#!/usr/bin/env bash

PATH=${PWD}/fixtures/cli-command:${PATH}
export XDG_CONFIG_HOME=/dev/null
TEMPLATE_DIR=${PWD}/../src/templates/cli/command
output=$(mktemp)
directory=$(mktemp -d)
trap "rm -r -- '${output}' '${directory}'" EXIT

before-each() {
  rm -rf -- "${directory}"
  mkdir "${directory}"
}

command-create() {
  cli cli command create -d "${directory}" "$@"
}

test-cli-create-basic-command() {
  command-create basic # &> "${output}"
  [ "$(stat -c%s "${output}")" -eq 0 ]
  diff "${directory}"/basic "${TEMPLATE_DIR}"/command
  diff "${directory}"/basic.context "${TEMPLATE_DIR}"/command.context
}

test-cli-create-nested-command() {
  command-create parent/child &> "${output}"
  [ "$(stat -c%s "${output}")" -eq 0 ]
  diff "${directory}"/parent/@main "${TEMPLATE_DIR}"/@main
  diff "${directory}"/parent/@main.context "${TEMPLATE_DIR}"/@main.context
  diff "${directory}"/parent/child "${TEMPLATE_DIR}"/command
  diff "${directory}"/parent/child.context "${TEMPLATE_DIR}"/command.context
}

test-cli-create-empty-command() {
  command-create '//' &> "${output}" && return 1
  diff "${output}" - <<EOF
[error] command is empty: //
EOF
}

test-cli-create-invalid-command() {
  command-create %command &> "${output}" && return 1
  diff "${output}" - <<EOF
[error] invalid command name: %command
EOF
}

test-cli-create-command-already-exists() {
  touch "${directory}"/command
  command-create command &> "${output}" && return 1
  diff "${output}" - <<EOF
[error] command already exists: command (use --force to overwrite)
EOF

  command-create command --force &> "${output}"
  [ "$(stat -c%s "${output}")" -eq 0 ]
  diff "${directory}"/command "${TEMPLATE_DIR}"/command
  diff "${directory}"/command.context "${TEMPLATE_DIR}"/command.context
}

test-cli-create-command-already-exists-as-non-terminal() {
  mkdir "${directory}"/command
  command-create command &> "${output}" && return 1
  diff "${output}" - <<EOF
[error] command already exists as a non-terminal: command
EOF
}

test-cli-create-command-already-exists-as-terminal() {
  touch "${directory}"/parent
  command-create parent/child &> "${output}" && return 1
  diff "${output}" - <<EOF
[error] command already exists as a terminal: parent
EOF
}

. ./lib/run-tests
