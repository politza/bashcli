#!/usr/bin/env bash

PATH=$PWD/fixtures/completion:${PATH}
output=$(mktemp)
trap "rm -r -- '${output}'" EXIT

before-each() {
  unset BASHCLI_CLI_CONFIG_LOCAL
}

# shellcheck disable=SC2206
completion-exec() {
  local IFS=$' '
  local prefix=${1%%|*}
  local suffix=${1#*|}
  local line=${prefix}${suffix}
  local words=(${line})
  local prefixWords=(${prefix}${suffix%% *})
  local previous=${prefixWords[-2]}
  local current=${prefixWords[-1]}
  IFS=$'\n'

  test-cli cli complete \
      --comp-cword "$((${#prefixWords[@]} - 1))" \
      --comp-line "${line}" \
      --comp-point "${#prefix}" \
      --comp-type 63 \
      --comp-words "${words[*]}" \
      -- cli "${current}" "${previous}" | sed 's/ *$//' | sort
}

test-complete-long-options() {
  completion-exec 'test-cli command --|' &> "${output}"
  diff "${output}" - <<EOF
--boolean   boolean option (-a,-b,-c)
--first     first enum option (-f)
--help      Shows a help message.
--multi=    multi option (-m)
--profile=  Enables one or more configuration profiles. (-P)
--second    second enum option
--single=   single option (-s)
--version   Displays version information about the program.
EOF
}

test-complete-option-argument() {
  completion-exec 'test-cli command --single=|' &> "${output}"
  diff "${output}" - <<EOF
single-0-completion  single-0-completion description
single-1-completion  single-1-completion description
EOF
}

test-complete-parameter-argument() {
  completion-exec 'test-cli command p|' &> "${output}"
  diff "${output}" - <<EOF
parameter-0-completion  parameter-0-completion description
parameter-1-completion  parameter-1-completion description
EOF
}

test-complete-profiles() {
  local configFile=$(mktemp)
  trap "rm -f -- '${configFile}'" RETURN EXIT

  export BASHCLI_CLI_CONFIG_LOCAL=${configFile}
  cat > "${configFile}" <<EOF
%test.property=0
%dev.property=1
EOF
  completion-exec 'test-cli command --profile=|' &> "${output}"
  diff "${output}" - <<EOF
default
dev
test
EOF
}

. ./lib/run-tests
