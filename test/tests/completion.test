#!/usr/bin/env bash

PATH=$PWD/fixtures/completion:${PATH}
output=$(mktemp)
trap "rm -r -- '${output}'" EXIT

before-each() {
  unset BASHCLI_CLI_CONFIG_LOCAL
}

bash-completion-has-comp_delimited() (
  if [ -f /usr/share/bash-completion/bash_completion ]; then
    . /usr/share/bash-completion/bash_completion
    declare -pf _comp_delimited &>/dev/null
  else
    return 1
  fi
)

# shellcheck disable=SC2206
completion-exec() {
  local IFS=$' '
  local prefix=${1%%|*}
  local suffix=${1#*|}
  local line=${prefix}${suffix}
  local words=(${line})
  local prefixWords=(${prefix}${suffix%% *})
  local previous=${prefixWords[-2]}
  local current=${prefixWords[-1]}
  IFS=$'\n'

  test-cli cli complete \
      --comp-cword "$((${#prefixWords[@]} - 1))" \
      --comp-line "${line}" \
      --comp-point "${#prefix}" \
      --comp-type 63 \
      --comp-words "${words[*]}" \
      -- cli "${current}" "${previous}" | sed 's/ *$//' | sort
}

test-complete-long-options() {
  completion-exec 'test-cli command --|' &> "${output}"
  diff "${output}" - <<EOF
--boolean     boolean option (-a,-b,-c)
--first       first enum option (-f)
--help        Shows a help message.
--multi-raw=  multi-raw option (-M)
--multi=      multi option (-m)
--profile=    Enables one or more configuration profiles. (-P)
--second      second enum option
--single=     single option (-s)
--version     Displays version information about the program.
EOF
}

test-complete-option-argument() {
  completion-exec 'test-cli command --single=|' &> "${output}"
  diff "${output}" - <<EOF
single-0
single-1
EOF
}

test-complete-parameter-argument() {
  completion-exec 'test-cli command p|' &> "${output}"
  diff "${output}" - <<EOF
parameter-0
parameter-1
EOF
}

test-complete-multi() {
  completion-exec 'test-cli command --multi m|' &> "${output}"
  diff "${output}" - <<EOF
multi-0
multi-1
multi-2
EOF
}

test-complete-multi-assignment() {
  completion-exec 'test-cli command --multi=m|' &> "${output}"
  diff "${output}" - <<EOF
multi-0
multi-1
multi-2
EOF
}

if bash-completion-has-comp_delimited; then
test-complete-multi-split() {
  completion-exec 'test-cli command --multi=multi-0' &> "${output}"
  diff "${output}" - <<EOF
multi-0,
EOF

  completion-exec 'test-cli command --multi=multi-0,' &> "${output}"
  diff "${output}" - <<EOF
multi-0,multi-1
multi-0,multi-2
EOF

  completion-exec 'test-cli command --multi=multi-0,multi-2,' &> "${output}"
  diff "${output}" - <<EOF
multi-0,multi-2,multi-1
EOF

  completion-exec 'test-cli command --multi=multi-0,multi-2,multi-1' &> "${output}"
  diff "${output}" - <<EOF
multi-0,multi-2,multi-1
EOF
}
fi

test-complete-multi-raw() {
  completion-exec 'test-cli command --multi-raw multi-raw' &> "${output}"
  diff "${output}" - <<EOF
multi-raw,0
multi-raw,1
EOF
}

test-complete-multi-raw-with-comma() {
  completion-exec 'test-cli command --multi-raw multi-raw,0' &> "${output}"
  diff "${output}" - <<EOF
multi-raw,0
EOF

  completion-exec 'test-cli command --multi-raw multi-raw,0,' &> "${output}"
  diff "${output}" - <<EOF
EOF
}

. ./lib/run-tests
