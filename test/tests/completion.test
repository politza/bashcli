#!/usr/bin/env bash

PATH=${PWD}/fixtures/completion:${PATH}
output=$(mktemp)
trap "rm -r -- '${output}'" EXIT

before-each() {
  unset BASHCLI_CLI_CONFIG_LOCAL
}

bash-completion-has-comp_delimited() (
  if [ -f /usr/share/bash-completion/bash_completion ]; then
    . /usr/share/bash-completion/bash_completion
    declare -pf _comp_delimited &>/dev/null
  else
    return 1
  fi
)

# shellcheck disable=SC2206
completion-exec() {
  local IFS=$' '
  local prefix=${1%%|*}
  local suffix=${1#*|}
  local line=${prefix}${suffix}
  local words=(${line})
  local prefixWords=(${prefix}${suffix%% *})
  local previous=${prefixWords[-2]}
  local current=${prefixWords[-1]}
  IFS=$'\n'

  test-cli cli completion \
      --comp-cword "$((${#prefixWords[@]} - 1))" \
      --comp-line "${line}" \
      --comp-point "${#prefix}" \
      --comp-type 63 \
      --comp-words "${words[*]}" \
      -- cli "${current}" "${previous}" | sed 's/ *$//' | sort
}

test-complete-long-options() {
  completion-exec 'test-cli command --|' &> "${output}"
  diff -u "${output}" - <<EOF
--boolean     boolean option (-a,-b,-c)
--debug       Configures debug logging.
--first       first enum option (-f)
--help        Shows a help message.
--multi       multi option (-M)
--multi-list  multi-list option (-m)
--profile     Enable one or more configuration profiles. (-P)
--second      second enum option
--single      single option (-s)
--version     Display version information about the program.
EOF
}

test-complete-option-argument() {
  completion-exec 'test-cli command --single=|' &> "${output}"
  diff "${output}" - <<EOF
single-0
single-1
EOF
}

test-complete-parameter-argument() {
  completion-exec 'test-cli command p|' &> "${output}"
  diff "${output}" - <<EOF
parameter-0
parameter-1
EOF
}

test-complete-multi-list() {
  completion-exec 'test-cli command --multi-list m|' &> "${output}"
  diff "${output}" - <<EOF
multi-list-0
multi-list-1
multi-list-2
EOF
}

test-complete-multi-list-assignment() {
  completion-exec 'test-cli command --multi-list=m|' &> "${output}"
  diff "${output}" - <<EOF
multi-list-0
multi-list-1
multi-list-2
EOF
}

if bash-completion-has-comp_delimited; then
test-complete-multi-list-split() {
  completion-exec 'test-cli command --multi-list=multi-list-0' &> "${output}"
  diff "${output}" - <<EOF
multi-list-0,
EOF

  completion-exec 'test-cli command --multi-list=multi-list-0,' &> "${output}"
  diff "${output}" - <<EOF
multi-list-0,multi-list-1
multi-list-0,multi-list-2
EOF

  completion-exec 'test-cli command --multi-list=multi-list-0,multi-list-2,' &> "${output}"
  diff "${output}" - <<EOF
multi-list-0,multi-list-2,multi-list-1
EOF

  completion-exec 'test-cli command --multi-list=multi-list-0,multi-list-2,multi-list-1' &> "${output}"
  diff "${output}" - <<EOF
multi-list-0,multi-list-2,multi-list-1
EOF
}
fi

test-complete-multi() {
  completion-exec 'test-cli command --multi multi' &> "${output}"
  diff "${output}" - <<EOF
multi,0
multi,1
EOF
}

test-complete-multi-with-comma() {
  completion-exec 'test-cli command --multi multi,0' &> "${output}"
  diff "${output}" - <<EOF
multi,0
EOF

  completion-exec 'test-cli command --multi multi,0,' &> "${output}"
  diff "${output}" - <<EOF
EOF
}

. ./lib/run-tests
