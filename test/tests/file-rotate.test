#!/usr/bin/env bash

PATH=${PWD}/fixtures/file-rotate:${PATH}
TEST_DIR=$(mktemp -d)

trap "rm -r -- '${TEST_DIR}'" EXIT

before-each() {
  cd "${TEST_DIR}" || return 1
  rm --force -- "${TEST_DIR}"/service.*

  echo 0 > service.log
  for count in 1 2 3; do
    echo ${count} > service.${count}.log
  done
}

test-file-rotate-basic() {
  file-rotate -m 2 service.log
  test -f service.1.log
  test -f service.2.log
  test -f service.3.log
  diff service.1.log - <<<0
  diff service.2.log - <<<1
  diff service.3.log - <<<3
}

test-file-rotate-pattern() {
  file-rotate -p %s.service.log service.log
  test -f 1.service.log
  test -f 2.service.log && return 1
  test -f 3.service.log && return 1
  test -f service.1.log
  test -f service.2.log
  test -f service.3.log
  diff 1.service.log - <<<0
  diff service.1.log - <<<1
  diff service.2.log - <<<2
  diff service.3.log - <<<3
}

test-file-rotate-max-kept() {
  file-rotate -m 1 service.log
  test -f service.1.log
  test -f service.2.log
  test -f service.3.log
  diff service.1.log - <<<0
  diff service.2.log - <<<2
  diff service.3.log - <<<3
}

. ./lib/run-tests
