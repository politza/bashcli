#!/usr/bin/env bash

PATH=$PWD/fixtures/config:${PATH}
output=$(mktemp)
localConfig=$(mktemp)
globalConfig=$(mktemp)

trap "rm -r -- '${output}' '${localConfig}' '${globalConfig}'" EXIT

before-each() {
  export BASHCLI_CONFIG_GLOBAL=${globalConfig}
  export BASHCLI_CLI_CONFIG_LOCAL=${localConfig}
  unset CLI_PROPERTY
  unset CLI__PROFILE_PROPERTY

  cat > "${localConfig}" <<EOF
property=local-value
%profile.property=local-profile-value
EOF

  cat > "${globalConfig}" <<EOF
property=global-value
%profile.property=global-profile-value
EOF
}

test-config-get-global-value() {
  cli cli config --global get property &> "${output}"
  diff "${output}" - <<<global-value

  BASHCLI_CLI_CONFIG_LOCAL=
  cli cli config get property &> "${output}"
  diff "${output}" - <<<global-value
}

test-config-get-local-value() {
  cli cli config --local get property &> "${output}"
  diff "${output}" - <<<local-value

  cli cli config get property &> "${output}"
  diff "${output}" - <<<local-value
}

test-config-get-env-value() {
  export CLI_PROPERTY=env-value

  cli cli config get --global property &> "${output}"
  diff "${output}" - <<<env-value

  cli cli config get --local property &> "${output}"
  diff "${output}" - <<<env-value

  cli cli config get property &> "${output}"
  diff "${output}" - <<<env-value
}

test-config-get-global-profile-value() {
  cli cli config --global --profile profile get property &> "${output}"
  diff "${output}" - <<<global-profile-value

  BASHCLI_CLI_CONFIG_LOCAL=
  cli cli config --profile profile get property &> "${output}"
  diff "${output}" - <<<global-profile-value
}

test-config-get-local-profile-value() {
  cli cli config --local --profile profile get property &> "${output}"
  diff "${output}" - <<<local-profile-value

  cli cli config get --profile profile property &> "${output}"
  diff "${output}" - <<<local-profile-value
}

test-config-get-env-profile-value() {
  export CLI__PROFILE_PROPERTY=env-profile-value
  export CLI_PROFILE=env-value

  cli cli config get --global --profile profile property &> "${output}"
  diff "${output}" - <<<env-profile-value

  cli cli config get --local --profile profile property &> "${output}"
  diff "${output}" - <<<env-profile-value

  cli cli config get --profile profile property &> "${output}"
  diff "${output}" - <<<env-profile-value
}

test-config-set-global-value() {
  cli cli config --global set property set-value &> "${output}"
  cli cli config --global get property &>> "${output}"
  diff "${output}" - <<<set-value
}

test-config-set-local-value() {
  cli cli config --local set property set-value &> "${output}"
  cli cli config --local get property &>> "${output}"
  diff "${output}" - <<<set-value
}

test-config-set-global-profile-value() {
  cli cli config --global --profile profile set property set-profile-value &> "${output}"
  cli cli config --global --profile profile get property &>> "${output}"
  diff "${output}" - <<<set-profile-value
}

test-config-set-local-profile-value() {
  cli cli config --local --profile profile set property set-profile-value &> "${output}"
  cli cli config --local --profile profile get property &>> "${output}"
  diff "${output}" - <<<set-profile-value
}

test-config-set-new-property() {
  cli cli config --global set new-property set-value &> "${output}"
  cli cli config --global get new-property &>> "${output}"
  diff "${output}" - <<<set-value
}

test-config-list-global() {
  cli cli config --global list &> "${output}"
  diff "${output}" - <<EOF
property=global-value
EOF
}

test-config-list-local() {
  cli cli config --local list &> "${output}"
  diff "${output}" - <<EOF
property=local-value
EOF
}

test-config-list-global-profile() {
  cli cli config --global --profile profile list &> "${output}"
  diff "${output}" - <<EOF
property=global-profile-value
EOF
}

test-config-list-local-profile() {
  cli cli config --local --profile profile list &> "${output}"
  diff "${output}" - <<EOF
property=local-profile-value
EOF
}

test-config-unset-global() {
  cli cli config --global unset property &> "${output}"
  [ "$(stat -c%s "${output}")" -eq 0 ]
  diff "${globalConfig}" - <<EOF
%profile.property=global-profile-value
EOF
}

test-config-unset-local() {
  cli cli config --local unset property &> "${output}"
  [ "$(stat -c%s "${output}")" -eq 0 ]
  diff "${localConfig}" - <<EOF
%profile.property=local-profile-value
EOF
}

test-config-unset-global-profile() {
  cli cli config --global --profile profile unset property &> "${output}"
  [ "$(stat -c%s "${output}")" -eq 0 ]
  diff "${globalConfig}" - <<EOF
property=global-value
EOF
}

test-config-unset-local-profile() {
  cli cli config --local --profile profile unset property &> "${output}"
  [ "$(stat -c%s "${output}")" -eq 0 ]
  diff "${localConfig}" - <<EOF
property=local-value
EOF
}

test-config-property-expression() {
  cat > "${globalConfig}" <<'EOF'
a=${b}
b=${c}
c=result
EOF
  cli cli config get a &> "${output}"
  diff "${output}" - <<<result
}

test-config-env-expression() {
  export TEST_CONFIG_ENV_EXPRESSION=result
  cat > "${globalConfig}" <<'EOF'
a=${b}
b=${c}
c=${TEST_CONFIG_ENV_EXPRESSION}
EOF
  cli cli config get a &> "${output}"
  diff "${output}" - <<<result
}

test-config-circular-expression() {
  cat > "${globalConfig}" <<'EOF'
a=${b}
b=${c}
c=${a}
EOF
  cli cli config get a &> "${output}" && return 1
  diff "${output}" - <<EOF
[error] apparent cyclic property dependencies found during evaluation
EOF
}

. ./lib/run-tests
