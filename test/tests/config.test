#!/usr/bin/env bash

PATH=${PWD}/fixtures/config:${PATH}
output=$(mktemp)
TEST_BASHCLI_LOCAL_DIR=$(mktemp -d)
TEST_BASHCLI_GLOBAL_DIR=$(mktemp -d)
TEST_BASHCLI_FILE_DIR=$(mktemp -d)
TEST_BASHCLI_LOCAL_CONFIG=${TEST_BASHCLI_LOCAL_DIR}/config/options.conf
TEST_BASHCLI_GLOBAL_CONFIG=${TEST_BASHCLI_GLOBAL_DIR}/config/options.conf
TEST_BASHCLI_FILE_CONFIG=${TEST_BASHCLI_FILE_DIR}/config/file.conf

trap "rm -r -- '${output}' '${TEST_BASHCLI_LOCAL_DIR}' '${TEST_BASHCLI_GLOBAL_DIR}' '${TEST_BASHCLI_FILE_DIR}'" EXIT

before-each() {
  export BASHCLI_GLOBAL_DIR=${TEST_BASHCLI_GLOBAL_DIR}
  export BASHCLI_LOCAL_DIR=${TEST_BASHCLI_LOCAL_DIR}
  unset CLI_OPTIONS_PROPERTY
  unset CLI_NS_PROPERTY
  unset _PROFILE_CLI_OPTIONS_PROPERTY
  unset _PROFILE_CLI_NS_PROPERTY

  mkdir --parents "${TEST_BASHCLI_LOCAL_CONFIG%/*}"
  mkdir --parents "${TEST_BASHCLI_GLOBAL_CONFIG%/*}"
  mkdir --parents "${TEST_BASHCLI_FILE_CONFIG%/*}"

  cat > "${TEST_BASHCLI_LOCAL_CONFIG}" <<EOF
property=local-value
%profile.property=local-profile-value
EOF

  cat > "${TEST_BASHCLI_GLOBAL_CONFIG}" <<EOF
property=global-value
%profile.property=global-profile-value
EOF

  cat > "${TEST_BASHCLI_FILE_CONFIG}" <<EOF
property=file-value
%profile.property=file-profile-value
EOF
}

test-config-get-global-value() {
  cli config --scopes global get property &> "${output}"
  diff "${output}" - <<<global-value

  BASHCLI_LOCAL_DIR=
  cli config get property &> "${output}"
  diff "${output}" - <<<global-value
}

test-config-get-local-value() {
  cli config --scopes local get property &> "${output}"
  diff "${output}" - <<<local-value

  cli config get property &> "${output}"
  diff "${output}" - <<<local-value
}

test-config-get-default-value() {
  cli config --scopes default get property &> "${output}"
  diff "${output}" - <<<default-value
}

test-config-get-ns-value() {
  cli config --namespace ns get property &> "${output}"
  diff "${output}" - <<<ns-default-value
}

test-config-get-file-value() {
  cli config --file "${TEST_BASHCLI_FILE_CONFIG}" get property &> "${output}"
  diff "${output}" - <<<file-value
}

test-config-get-env-value() {
  export CLI_OPTIONS_PROPERTY=env-value
  export CLI_NS_PROPERTY=ns-env-value

  cli config get --scopes global property &> "${output}"
  diff "${output}" - <<<env-value

  cli config get --scopes local property &> "${output}"
  diff "${output}" - <<<env-value

  cli config get --scopes default property &> "${output}"
  diff "${output}" - <<<env-value

  cli config get property &> "${output}"
  diff "${output}" - <<<env-value

  cli config get --namespace ns property &> "${output}"
  diff "${output}" - <<<ns-env-value
}

test-config-get-global-profile-value() {
  cli config --scopes global --profile profile get property &> "${output}"
  diff "${output}" - <<<global-profile-value

  BASHCLI_LOCAL_DIR=
  cli config --profile profile get property &> "${output}"
  diff "${output}" - <<<global-profile-value
}

test-config-get-local-profile-value() {
  cli config --scopes local --profile profile get property &> "${output}"
  diff "${output}" - <<<local-profile-value

  cli config get --profile profile property &> "${output}"
  diff "${output}" - <<<local-profile-value
}

test-config-get-default-profile-value() {
  cli config --scopes default --profile profile get property &> "${output}"
  diff "${output}" - <<<default-profile-value
}

test-config-get-env-profile-value() {
  export CLI_PROFILE=env-value
  export CLI_NS_PROPERTY=ns-env-value
  export _PROFILE_CLI_OPTIONS_PROPERTY=env-profile-value
  export _PROFILE_CLI_NS_PROPERTY=ns-env-profile-value

  cli config get --scopes global --profile profile property &> "${output}"
  diff "${output}" - <<<env-profile-value

  cli config get --scopes local --profile profile property &> "${output}"
  diff "${output}" - <<<env-profile-value

  cli config get --profile profile property &> "${output}"
  diff "${output}" - <<<env-profile-value

  cli config get --profile profile property &> "${output}"
  diff "${output}" - <<<env-profile-value

  cli config get --namespace ns --profile profile property &> "${output}"
  diff "${output}" - <<<ns-env-profile-value

  cli config get --namespace ns --file "${TEST_BASHCLI_FILE_CONFIG}" --profile profile property &> "${output}"
  diff "${output}" - <<<ns-env-profile-value
}

test-config-set-global-value() {
  cli config --scopes global set property set-value &> "${output}"
  cli config --scopes global get property &>> "${output}"
  diff "${output}" - <<<set-value
}

test-config-set-local-value() {
  cli config --scopes local set property set-value &> "${output}"
  cli config --scopes local get property &>> "${output}"
  diff "${output}" - <<<set-value
}

test-config-set-default-value() {
  cli config --scopes default set property set-value &> "${output}" && return 1
  diff "${output}" - <<EOF
[error] builtin and default scopes are read-only
EOF
}

test-config-set-file-value() {
  cli config --file "${TEST_BASHCLI_FILE_CONFIG}" set property set-value &> "${output}"
  cli config --file "${TEST_BASHCLI_FILE_CONFIG}" get property &>> "${output}"
  diff "${output}" - <<<set-value
}

test-config-set-using-multiple-scopes() {
  cli config --scopes global,local set property set-value &> "${output}" && return 1
  diff "${output}" - <<EOF
[error] require a single scope or config-file when updating properties
EOF
}

test-config-set-global-profile-value() {
  cli config --scopes global set --profile profile property set-profile-value &> "${output}"
  cli config --scopes global --profile profile get property &>> "${output}"
  diff "${output}" - <<<set-profile-value
}

test-config-set-local-profile-value() {
  cli config --scopes local set --profile profile property set-profile-value &> "${output}"
  cli config --scopes local --profile profile get property &>> "${output}"
  diff "${output}" - <<<set-profile-value
}

test-config-set-new-property() {
  cli config --scopes global set new-property set-value &> "${output}"
  cli config --scopes global get new-property &>> "${output}"
  diff "${output}" - <<<set-value
}

test-config-list-global() {
  cli config --scopes global list &> "${output}"
  diff "${output}" - <<EOF
property=global-value
EOF
}

test-config-list-local() {
  cli config --scopes local list &> "${output}"
  diff "${output}" - <<EOF
property=local-value
EOF
}

test-config-list-default() {
  cli config --scopes default list &> "${output}"
  diff "${output}" - <<EOF
property=default-value
EOF
}

test-config-list-ns() {
  cli config --namespace ns list &> "${output}"
  diff "${output}" - <<EOF
property=ns-default-value
EOF
}

test-config-list-file() {
  cli config --file "${TEST_BASHCLI_FILE_CONFIG}" list &> "${output}"
  diff "${output}" - <<EOF
property=file-value
EOF
}

test-config-list-global-profile() {
  cli config --scopes global --profile profile list &> "${output}"
  diff "${output}" - <<EOF
property=global-profile-value
EOF
}

test-config-list-local-profile() {
  cli config --scopes local --profile profile list &> "${output}"
  diff "${output}" - <<EOF
property=local-profile-value
EOF
}

test-config-list-default-profile() {
  cli config --scopes default --profile profile list &> "${output}"
  diff "${output}" - <<EOF
property=default-profile-value
EOF
}

test-config-unset-global() {
  cli config --scopes global unset property &> "${output}"
  [ "$(stat -c%s "${output}")" -eq 0 ]
  diff "${TEST_BASHCLI_GLOBAL_CONFIG}" - <<EOF
%profile.property=global-profile-value
EOF
}

test-config-unset-local() {
  cli config --scopes local unset property &> "${output}"
  [ "$(stat -c%s "${output}")" -eq 0 ]
  diff "${TEST_BASHCLI_LOCAL_CONFIG}" - <<EOF
%profile.property=local-profile-value
EOF
}

test-config-unset-local() {
  cli config --scopes default unset property &> "${output}" && return 1
  diff "${output}" - <<EOF
[error] builtin and default scopes are read-only
EOF
}

test-config-unset-global-profile() {
  cli config --scopes global unset --profile profile property &> "${output}"
  [ "$(stat -c%s "${output}")" -eq 0 ]
  diff "${TEST_BASHCLI_GLOBAL_CONFIG}" - <<EOF
property=global-value
EOF
}

test-config-unset-local-profile() {
  cli config --scopes local unset --profile profile property &> "${output}"
  [ "$(stat -c%s "${output}")" -eq 0 ]
  diff "${TEST_BASHCLI_LOCAL_CONFIG}" - <<EOF
property=local-value
EOF
}

test-config-property-expression() {
  cat > "${TEST_BASHCLI_GLOBAL_CONFIG}" <<'EOF'
a=${b}
b=${c}
c=result
EOF
  cli config get a &> "${output}"
  diff "${output}" - <<<result
}

test-config-env-expression() {
  export TEST_CONFIG_ENV_EXPRESSION=result
  cat > "${TEST_BASHCLI_GLOBAL_CONFIG}" <<'EOF'
a=${b}
b=${c}
c=${TEST_CONFIG_ENV_EXPRESSION}
EOF
  cli config get a &> "${output}"
  diff "${output}" - <<<result
}

test-config-circular-expression() {
  cat > "${TEST_BASHCLI_GLOBAL_CONFIG}" <<'EOF'
a=${b}
b=${c}
c=${a}
EOF
  cli config get a &> "${output}" && return 1
  diff "${output}" - <<EOF
[error] apparent cyclic property dependencies found during evaluation
EOF
}

. ./lib/run-tests
