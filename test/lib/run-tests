#!/usr/bin/env bash

# Execute all functions having a name starting with 'test-', print the result in the TAP format and
# exit.

tests=()
readarray -t tests <<<"$(compgen -A function | grep '^test-' | grep -E "${_BASHCLI_TEST_SELECTOR:-.}")"

echo "1..${#tests[@]}"

for ((index = 0; index < ${#tests[@]}; ++index)); do
  if declare -F before-each &>/dev/null; then
    before-each
  fi
  test=${tests[index]}
  (set -e; ${test}) 1>&2
  if [ $? -eq 0 ]; then
    echo "ok $((index + 1)) - ${test}"
  else
    echo "not ok $((index + 1)) - ${test}"
  fi
  if declare -F after-each &>/dev/null; then
    after-each
  fi
done

exit 0
