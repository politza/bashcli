#!/usr/bin/env bash

set -e

usage() {
  cat <<EOF
usage:$(basename "$0") [--force|-f] CLI [DIRECTORY]

Creates a single-file script of a CLI in DIRECTORY, which defaults to the current one.
EOF
}

options=$(getopt -o f -l force,help -n "$(basename "$0")" -- "$@") || {
  exit 1
}
eval set -- "$options"

while [ $# -gt 0 ]; do
  case $1 in
    --help)
      usage
      exit 0;;
    -f|--force)
      force=true ;;
    --) shift
        break;
  esac
  shift
done

[ $# -eq 1 ] || [ $# -eq 2 ] || {
  usage
  exit 1
}

bashcli=$(realpath "$(dirname "$0")/../src/bashcli")
cli=$1
outputDir=${2:-$PWD}

[ -f "${bashcli}" ] || {
  echo "no such file: ${bashcli}"
  exit 1
}

[ "$(basename "${bashcli}")" == bashcli ] || {
  echo "no bashcli: ${bashcli}"
  exit 1
}

[ -L "${cli}" ] || {
  echo "not a symbolic link: ${cli}"
  exit 1
}

[ "$(realpath "${cli}")" -ef "${bashcli}" ] || {
  echo "not a bashcli link: ${cli}"
  exit 1
}

cliName=$(basename "${cli}")

if [ -e "${outputDir}/${cliName}" ] && [ -z "${force}" ]; then
  echo "file exists: ${outputDir}/${cliName}"
  exit 1
fi

mkdir --parents "${outputDir}"

tempDir=$(mktemp -d)
trap 'rm -rf -- "${tempDir}"' EXIT

archiveName=${tempDir}/${cliName}.tar.xz

cp --archive "$(dirname "${bashcli}")/." "${tempDir}/bashcli"
cp --archive "$(dirname "${cli}")/." "${tempDir}/${cliName}"
ln --force --symbolic ../bashcli/bashcli "${tempDir}/${cliName}/${cliName}"

hashSum=$(cd "${tempDir}" && find . -type f -print0 | xargs -0rn1 sha1sum | sha1sum - | cut -d' ' -f1)
tar -cJf "${archiveName}" -C "${tempDir}" bashcli "${cliName}"

cat > "${outputDir}/${cliName}" <<EOF
#!/usr/bin/env bash

set -e

export BASHCLI_DIST=${hashSum}
CACHE_DIR=\${XDG_CACHE_HOME:-\${HOME}/.cache}/${cliName}/dist/\${BASHCLI_DIST}
CLI_SCRIPT=\${CACHE_DIR}/${cliName}/${cliName}

if ! [ -f "\${CLI_SCRIPT}" ]; then
   if [ "\${BASHCLI_DEBUG}" == true ]; then
      echo "[debug](${cliName}) extracting into \${CACHE_DIR}" >&2
   fi
   mkdir --parents "\${CACHE_DIR}"
   ARCHIVE_LINE=\$(awk '/^__ARCHIVE__/ {print NR + 1; exit 0; }' "\$0")
   tail -n+\${ARCHIVE_LINE} "\$0" | tar -xJ -C "\${CACHE_DIR}"
fi

if [ "\${BASHCLI_DEBUG}" == true ]; then
   echo "[debug](${cliName}) executing \${CLI_SCRIPT}" >&2
fi
exec "\${CLI_SCRIPT}" "\$@"

__ARCHIVE__
EOF

cat "${archiveName}" >> "${outputDir}/${cliName}"
chmod +x "${outputDir}/${cliName}"
