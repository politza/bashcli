#!/usr/bin/env bash

set -e

testFiles=(test/tests)
testDirectory="$(dirname "$0")"/../test
proveArgs=(-r --ext test)
options=$(getopt -o s:Ddvj -n "$(basename "$0")" -- "$@") || {
  exit 1
}
eval set -- "$options"

while [ $# -gt 0 ]; do
  case $1 in
    -s) shift
        export _BASHCLI_TEST_SELECTOR=$1 ;;
    -D) unset BASHCLI_DEBUG ;;
    -d) export BASHCLI_DEBUG=true ;;
    -v) proveArgs+=(-v) ;;
    -j) proveArgs+=(-j8) ;;
    --) shift
        break;
  esac
  shift
done

if [ $# -gt 0 ]; then
  testFiles=("$@")
fi

for ((index = 0; index < ${#testFiles[@]}; ++index)); do
  testFiles[index]=$(realpath --relative-to="${testDirectory}" "${testFiles[index]}")
done

cd "${testDirectory}"
prove "${proveArgs[@]}" "${testFiles[@]}"
