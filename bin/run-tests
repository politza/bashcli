#!/usr/bin/env bash

set -e

testFiles=(test/tests)
testDirectory="$(dirname "$0")"/../test
proveArgs=(-r --ext test)

while getopts "s:Ddvj" option; do
  case ${option} in
    s) export BASHCLI_TEST_SELECTOR=${OPTARG} ;;
    D) unset BASHCLI_DEBUG ;;
    d) export BASHCLI_DEBUG=true ;;
    v) proveArgs+=(-v) ;;
    j) proveArgs+=(-j8) ;;
    *) exit 1
  esac
done
shift "$((OPTIND - 1))"

if [ $# -gt 0 ]; then
  testFiles=("$@")
fi

for ((index = 0; index < ${#testFiles[@]}; ++index)); do
  testFiles[index]=$(realpath --relative-to="${testDirectory}" "${testFiles[index]}")
done

cd "${testDirectory}"
prove "${proveArgs[@]}" "${testFiles[@]}"
